name: OpenAI Code Rewriting

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code repository
        uses: actions/checkout@v2

      - name: Create workspace directory
        run: |
          mkdir -p workspace/repo
          rsync -av --exclude='workspace/' . workspace/repo/
        working-directory: ${{ github.workspace }}

      - name: Install dependencies
        run: |
          cd workspace/repo/
          if [ -f package.json ]; then mv package.json .package.json; fi
          npm install
        working-directory: ${{ github.workspace }}

      - name: Rewrite code using OpenAI
        run: |
          cd workspace/repo/
          node <<EOF
          const openai = require('openai');
          const recursive = require('recursive-readdir');
          const fs = require('fs');
          const apiKey = process.env.OPENAI_API_KEY;
          const model = 'text-davinci-002';
          const languagePromptMap = {
            'js': 'Please rewrite my JavaScript code to the highest level of programming',
            'ts': 'Please rewrite my TypeScript code to the highest level of programming',
            'py': 'Please rewrite my Python code to the highest level of programming',
            // add more languages here as needed
          };
          const stopSequences = {
            'js': [';', '}'],
            'ts': [';', '}'],
            'py': [':', '\n'],
            // add more languages here as needed
          };
          recursive('.', (err, files) => {
            if (err) {
              throw err;
            }
            files.forEach((file) => {
              const fileExtension = file.split('.').pop();
              const languagePrompt = languagePromptMap[fileExtension];
              if (languagePrompt) {
                const stopSequence = stopSequences[fileExtension];
                const code = fs.readFileSync(file, 'utf8');
                const inputs = languagePrompt + '\n\nFile: ' + file + '\n\n' + code;
                const options = {
                  engine: 'davinci',
                  prompt: inputs,
                  maxTokens: 2048,
                  temperature: 0.9,
                  n: 1,
                  stream: false,
                  stop: stopSequence,
                };
                openai.completions.create(options, apiKey).then((result) => {
                  const rewrittenCode = result.choices[0].text.trim();
                  fs.writeFileSync(file, rewrittenCode);
                });
              }
            });
          });
          EOF
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        working-directory: ${{ github.workspace }}

      - name: Push changes to branch
        uses: ad-m/github-push-action@v0.6.0
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          branch: ${{ github.head_ref }}
