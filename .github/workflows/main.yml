name: OpenAI Code Rewrite

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  rewrite:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Create workspace directory
        run: mkdir -p workspace

      - name: Copy repository to workspace
        run: cp -R --exclude=workspace . workspace/repo/

      - name: Move into workspace
        run: cd workspace/repo/

      - name: Rename package.json
        run: if [ -f package.json ]; then mv package.json .package.json; fi

      - name: Install dependencies
        run: npm install openai recursive-readdir

      - name: Rewrite code using OpenAI
        run: |
          node <<EOF
          const openai = require('openai');
          const recursive = require('recursive-readdir');
          const fs = require('fs');
          const apiKey = process.env.OPENAI_API_KEY;
          const model = 'text-davinci-002';
          const languagePromptMap = {
            'js': 'Please rewrite my JavaScript code to the highest level of programming',
            'ts': 'Please rewrite my TypeScript code to the highest level of programming',
            'py': 'Please rewrite my Python code to the highest level of programming',
            // add more languages here as needed
          };
          const stopSequences = {
            'js': [';', '}'],
            'ts': [';', '}'],
            'py': [':', '\n'],
            // add more languages here as needed
          };
          recursive('.', (err, files) => {
            if (err) {
              throw err;
            }
            files.forEach((file) => {
              const fileExtension = file.split('.').pop();
              const languagePrompt = languagePromptMap[fileExtension];
              if (languagePrompt) {
                const stopSequence = stopSequences[fileExtension];
                const code = fs.readFileSync(file, 'utf8');
                const inputs = languagePrompt + '\n\nFile: ' + file + '\n\n' + code;
                const options = {
                  engine: 'davinci',
                  prompt: inputs,
                  maxTokens: 2048,
                  temperature: 0.9,
                  n: 1,
                  stream: false,
                  stop: stopSequence,
                };
                openai.completions.create(options, apiKey).then((result) => {
                  const rewrittenCode = result.choices[0].text.trim();
                  fs.writeFileSync(file, rewrittenCode);
                });
              }
            });
          });
          EOF

      - name: Move back to root directory
        run: cd ../../

      - name: Commit changes
        uses: EndBug/add-and-commit@v7
        with:
          author_name: GitHub Actions
          author_email: actions@github.com
          message: Automated code rewrite using OpenAI
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
